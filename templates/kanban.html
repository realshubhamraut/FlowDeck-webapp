{% extends "base.html" %}

{% block title %}Kanban Board - FlowDeck{% endblock %}

{% block extra_css %}
<style>
    /* Override container width for kanban board */
    .container {
        max-width: 95% !important;
        padding: 0 2rem;
    }
    
    .kanban-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 2rem;
        margin-top: 2rem;
    }
    
    .kanban-column {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.25rem;
        min-height: 500px;
        border: 3px solid #dee2e6;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        min-width: 320px;
    }
    
    .kanban-column[data-status="todo"] {
        border-color: #6c757d;
        border-top: 5px solid #6c757d;
    }
    
    .kanban-column[data-status="in_progress"] {
        border-color: #007bff;
        border-top: 5px solid #007bff;
    }
    
    .kanban-column[data-status="review"] {
        border-color: #ffc107;
        border-top: 5px solid #ffc107;
    }
    
    .kanban-column[data-status="done"] {
        border-color: #28a745;
        border-top: 5px solid #28a745;
    }
    
    .kanban-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #dee2e6;
    }
    
    .kanban-title {
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .kanban-count {
        background: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.9rem;
        color: #666;
    }
    
    .task-card {
        background: white;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        cursor: move;
        transition: all 0.3s;
        border-left: 4px solid #667eea;
        min-height: 120px;
    }
    
    .task-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .task-card.dragging {
        opacity: 0.5;
    }
    
    .task-card-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #333;
        font-size: 1.05rem;
        line-height: 1.4;
        word-wrap: break-word;
    }
    
    .task-card-description {
        font-size: 0.95rem;
        color: #666;
        margin-bottom: 1rem;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-wrap: break-word;
    }
    
    .task-card-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.85rem;
    }
    
    .task-card-assigned {
        color: #666;
    }
    
    .kanban-column.drag-over {
        background: #e7f3ff;
        border: 2px dashed #667eea;
    }
    
    .priority-low {
        border-left-color: #28a745;
    }
    
    .priority-medium {
        border-left-color: #ffc107;
    }
    
    .priority-high {
        border-left-color: #fd7e14;
    }
    
    .priority-urgent {
        border-left-color: #dc3545;
    }
    
    @media (max-width: 1600px) {
        .kanban-container {
            gap: 1.5rem;
        }
        .kanban-column {
            min-width: 280px;
        }
    }
    
    @media (max-width: 1200px) {
        .kanban-container {
            grid-template-columns: repeat(2, 1fr);
        }
        .container {
            max-width: 100% !important;
        }
    }
    
    @media (max-width: 768px) {
        .kanban-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="color: #343a40; margin: 0; font-size: 2rem;">Kanban Board</h1>
    <div style="display: flex; gap: 1rem;">
        <button class="btn btn-success" onclick="openCreateTaskModal()">+ Create Task</button>
        <a href="{{ url_for('tasks') }}" class="btn btn-secondary">View All Tasks</a>
    </div>
</div>

<div class="kanban-container">
    <div class="kanban-column" data-status="todo">
        <div class="kanban-header">
            <div class="kanban-title">
                To Do
            </div>
            <div class="kanban-count">{{ tasks_by_status.todo|length }}</div>
        </div>
        <div class="kanban-tasks">
            {% for task in tasks_by_status.todo %}
            <div class="task-card priority-{{ task.priority }}" draggable="true" data-task-id="{{ task.id }}">
                <div class="task-card-title">{{ task.title }}</div>
                {% if task.description %}
                <div class="task-card-description">{{ task.description }}</div>
                {% endif %}
                <div class="task-card-meta">
                    <span class="badge badge-{{ task.priority }}">{{ task.priority|title }}</span>
                    <span class="task-card-assigned">
                        {% if task.assigned_to_name %}
                        {{ task.assigned_to_name }}
                        {% else %}
                        Unassigned
                        {% endif %}
                    </span>
                </div>
                {% if task.due_date %}
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #999;">
                    Due: {{ task.due_date }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="kanban-column" data-status="in_progress">
        <div class="kanban-header">
            <div class="kanban-title">
                In Progress
            </div>
            <div class="kanban-count">{{ tasks_by_status.in_progress|length }}</div>
        </div>
        <div class="kanban-tasks">
            {% for task in tasks_by_status.in_progress %}
            <div class="task-card priority-{{ task.priority }}" draggable="true" data-task-id="{{ task.id }}">
                <div class="task-card-title">{{ task.title }}</div>
                {% if task.description %}
                <div class="task-card-description">{{ task.description }}</div>
                {% endif %}
                <div class="task-card-meta">
                    <span class="badge badge-{{ task.priority }}">{{ task.priority|title }}</span>
                    <span class="task-card-assigned">
                        {% if task.assigned_to_name %}
                        {{ task.assigned_to_name }}
                        {% else %}
                        Unassigned
                        {% endif %}
                    </span>
                </div>
                {% if task.due_date %}
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #999;">
                    Due: {{ task.due_date }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="kanban-column" data-status="review">
        <div class="kanban-header">
            <div class="kanban-title">
                Review
            </div>
            <div class="kanban-count">{{ tasks_by_status.review|length }}</div>
        </div>
        <div class="kanban-tasks">
            {% for task in tasks_by_status.review %}
            <div class="task-card priority-{{ task.priority }}" draggable="true" data-task-id="{{ task.id }}">
                <div class="task-card-title">{{ task.title }}</div>
                {% if task.description %}
                <div class="task-card-description">{{ task.description }}</div>
                {% endif %}
                <div class="task-card-meta">
                    <span class="badge badge-{{ task.priority }}">{{ task.priority|title }}</span>
                    <span class="task-card-assigned">
                        {% if task.assigned_to_name %}
                        {{ task.assigned_to_name }}
                        {% else %}
                        Unassigned
                        {% endif %}
                    </span>
                </div>
                {% if task.due_date %}
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #999;">
                    Due: {{ task.due_date }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="kanban-column" data-status="done">
        <div class="kanban-header">
            <div class="kanban-title">
                Done
            </div>
            <div class="kanban-count">{{ tasks_by_status.done|length }}</div>
        </div>
        <div class="kanban-tasks">
            {% for task in tasks_by_status.done %}
            <div class="task-card priority-{{ task.priority }}" draggable="true" data-task-id="{{ task.id }}">
                <div class="task-card-title">{{ task.title }}</div>
                {% if task.description %}
                <div class="task-card-description">{{ task.description }}</div>
                {% endif %}
                <div class="task-card-meta">
                    <span class="badge badge-{{ task.priority }}">{{ task.priority|title }}</span>
                    <span class="task-card-assigned">
                        {% if task.assigned_to_name %}
                        {{ task.assigned_to_name }}
                        {% else %}
                        Unassigned
                        {% endif %}
                    </span>
                </div>
                {% if task.due_date %}
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #999;">
                    Due: {{ task.due_date }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Create Task Modal -->
<div id="createTaskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create New Task</h2>
            <span class="close" onclick="closeCreateTaskModal()">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('create_task') }}">
            <div class="form-group">
                <label for="title">Task Title</label>
                <input type="text" class="form-control" id="title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="description">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="priority">Priority</label>
                <select class="form-control" id="priority" name="priority" required>
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="assigned_to">Assign To</label>
                <select class="form-control" id="assigned_to" name="assigned_to">
                    <option value="">Unassigned</option>
                    {% for employee in employees %}
                    <option value="{{ employee.id }}">{{ employee.full_name }} - {{ employee.job_level|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="due_date">Due Date</label>
                <input type="date" class="form-control" id="due_date" name="due_date">
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                Create Task
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let draggedElement = null;
    
    // Add event listeners to all task cards
    document.querySelectorAll('.task-card').forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    // Add event listeners to all kanban columns
    document.querySelectorAll('.kanban-column').forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragleave', handleDragLeave);
    });
    
    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }
    
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('drag-over');
        });
    }
    
    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
        return false;
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    async function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        this.classList.remove('drag-over');
        
        if (draggedElement !== this) {
            const newStatus = this.getAttribute('data-status');
            const taskId = draggedElement.getAttribute('data-task-id');
            
            try {
                const response = await fetch('/kanban/update-position', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: taskId,
                        status: newStatus,
                        position: 0
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating task: ' + error);
            }
        }
        
        return false;
    }
    
    function openCreateTaskModal() {
        document.getElementById('createTaskModal').classList.add('active');
    }
    
    function closeCreateTaskModal() {
        document.getElementById('createTaskModal').classList.remove('active');
    }
</script>
{% endblock %}
